# Review Diff Feature

**Status**: Partially Implemented
**Last Updated**: 2025-12-28

A TUI-based code review workflow for reviewing changes generated by AI agents or collaborators.

---

## Overview

The Review Diff feature transforms Fresh Editor into a "decision engine" for reviewing, annotating, and staging code changes. It's specifically designed for the human-in-the-loop workflow when working with AI coding agents.

### Core Capabilities

| Feature | Status | Description |
|---------|--------|-------------|
| Unified Diff View | âœ… Done | Single scrollable stream of all changes |
| Colorized Diff | âœ… Done | Red=removed, Green=added, Blue=context |
| Hunk Navigation | âœ… Done | `n`/`p` keys jump between hunks |
| Per-Hunk Staging | âœ… Done | `s`/`d` to stage/discard hunks |
| Side-by-Side Drill-down | âœ… Done | `Enter` opens synchronized split view |
| Line-Level Comments | âœ… Done | `c` to comment on specific lines |
| Hunk Status Marking | âœ… Done | `a`pprove, `x`reject, `!`needs-changes |
| Export to Markdown | âœ… Done | `E` exports to `.review/session.md` |
| Export to JSON | âœ… Done | Structured format for agent consumption |
| Help Header | âœ… Done | Keybindings visible at top of buffer |
| Original Prompt Display | âŒ TODO | Show what user asked the agent to do |
| Summary Header | âŒ TODO | At-a-glance change summary |
| Safety Guardrails | âŒ TODO | Warn about secrets, deletions, etc. |
| Conflict Resolution | ðŸ”§ Scaffolded | 3-pane merge view |

---

## Quick Start

1. Open Review Diff: `Ctrl+P` â†’ "Review Diff"
2. Navigate: Arrow keys to move, `n`/`p` to jump between hunks
3. Comment: `c` on any line to add feedback
4. Review: `a` approve, `x` reject, `!` needs changes
5. Export: `E` to save feedback to `.review/session.md`

---

## Keyboard Shortcuts (review-mode)

### Navigation
| Key | Action |
|-----|--------|
| `n` | Next hunk |
| `p` | Previous hunk |
| `Enter` | Drill down to side-by-side view |
| `r` | Refresh diff |
| `q` | Close buffer |
| Arrow keys | Move cursor within buffer |

### Commenting
| Key | Action |
|-----|--------|
| `c` | Add comment at cursor position |
| `O` | Set overall session feedback |

### Review Status
| Key | Action |
|-----|--------|
| `a` | Approve hunk |
| `x` | Reject hunk |
| `!` | Mark as needs changes |
| `?` | Mark with question |
| `u` | Clear/undo status |

### Staging
| Key | Action |
|-----|--------|
| `s` | Stage hunk (accept change) |
| `d` | Discard hunk (reject change) |

### Export
| Key | Action |
|-----|--------|
| `E` | Export to `.review/session.md` |

---

## Comment System

Comments are attached to specific file line numbers (not hunk-relative), making them robust to rebases and squashes.

### Adding Comments

1. Navigate to a specific line in the diff
2. Press `c`
3. Enter your comment text
4. Press Enter to confirm

The prompt shows the line reference:
- `Comment on +42:` for added lines (new file line 42)
- `Comment on -38:` for removed lines (old file line 38)
- `Comment on hunk:` when on hunk header

### Comment Display

Comments appear inline after the line they reference:

```
â”‚   - const token = req.headers.auth;
â”‚   + const token = req.headers.authorization;
â”‚   Â» [+45] Consider adding validation here
â”‚         const decoded = jwt.verify(token);
```

### Export Format

Comments are exported with full context:

**Markdown (`.review/session.md`)**:
```markdown
## File: src/auth.ts

### validateToken (line 45)
**Status**: NEEDS_CHANGES

**Comments:**
> Â» [+45] Consider adding validation here
> `const token = req.headers.authorization;`
```

**JSON (`.review/session.json`)**:
```json
{
  "files": {
    "src/auth.ts": {
      "hunks": [{
        "context": "validateToken",
        "new_lines": [45, 52],
        "old_lines": [45, 50],
        "status": "needs_changes",
        "comments": [{
          "text": "Consider adding validation here",
          "line_type": "add",
          "new_line": 45,
          "line_content": "+const token = req.headers.authorization;"
        }]
      }]
    }
  }
}
```

---

## Agent Integration

The export formats are designed for any AI coding agent to consume:

```
Before making changes, check for review feedback:
1. Read `.review/session.md` if it exists
2. Address each NEEDS_CHANGES item
3. Do not re-apply REJECTED changes
4. Keep APPROVED changes as-is
```

Compatible with: Claude Code, Cursor, Aider, GitHub Copilot, and any agent that can read files.

---

## Architecture

### Components

```
plugins/audit_mode.ts     # Main plugin (TypeScript)
  â”œâ”€â”€ getGitDiff()        # Parses `git diff HEAD`
  â”œâ”€â”€ renderReviewStream()# Generates virtual buffer content
  â”œâ”€â”€ review_* actions    # Keybinding handlers
  â””â”€â”€ export functions    # Markdown/JSON generation

src/services/plugins/     # Rust runtime
  â”œâ”€â”€ Virtual Buffers     # Read-only buffers with metadata
  â”œâ”€â”€ Text Properties     # Per-line metadata (hunkId, lineType, etc.)
  â””â”€â”€ Overlays            # Diff highlighting
```

### Data Structures

```typescript
interface ReviewComment {
  id: string;
  hunk_id: string;
  file: string;
  text: string;
  timestamp: string;
  old_line?: number;      // Line in old file version
  new_line?: number;      // Line in new file version
  line_content?: string;  // Actual line text for context
  line_type?: 'add' | 'remove' | 'context';
}

interface Hunk {
  id: string;
  file: string;
  range: { start: number; end: number };      // New file lines
  oldRange: { start: number; end: number };   // Old file lines
  lines: string[];
  status: 'pending' | 'staged' | 'discarded';
  reviewStatus: 'pending' | 'approved' | 'rejected' | 'needs_changes' | 'question';
  contextHeader: string;  // Function/class name from @@ line
  byteOffset: number;     // Position in virtual buffer
}
```

---

## Side-by-Side View

The side-by-side drill-down view (`Enter` on a hunk) shows both file versions simultaneously with synchronized scrolling.

### Current Implementation

- **Left pane**: NEW version (current file) - editable working copy
- **Right pane**: OLD version (`[OLD â—€] filename`) - read-only virtual buffer with editing disabled
- **Scroll sync**: Viewport changes trigger `setSplitScroll` for synchronized scrolling
- **Activation**: Press `Enter` on any line within a hunk

**Note**: The layout is NEW|OLD rather than the conventional OLD|NEW due to the split API creating new panes to the right. The `[OLD â—€]` label makes it clear which pane is the reference version.

---

## UX Evaluation (NN/g Heuristics)

Evaluation of side-by-side diff view against [Nielsen Norman Group's 10 Usability Heuristics](https://www.nngroup.com/articles/ten-usability-heuristics/).

### Issues Found

#### ~~Critical: Read-Only Not Enforced~~ âœ… FIXED
**Heuristic**: #5 Error Prevention
- **Issue**: The OLD file buffer accepted text input despite `read_only: true` setting
- **Fix**: Added `editing_disabled: true` to the virtual buffer creation options

#### High: Reversed Pane Order (Known Limitation)
**Heuristic**: #2 Match Between System and Real World
- **Issue**: NEW file is on LEFT, OLD file is on RIGHT
- **Expected**: OLD on LEFT â†’ NEW on RIGHT (reading direction: past â†’ present)
- **Convention**: GitHub, GitLab, VS Code, and all major diff tools use OLD|NEW order
- **Impact**: Violates the mental model that left=before, right=after
- **Status**: API limitation - `createVirtualBufferInSplit` creates splits to the right
- **Mitigation**: Clear `[OLD â—€]` label distinguishes the reference version

#### High: No Line-Level Alignment
**Heuristic**: #6 Recognition Rather Than Recall
- **Issue**: Lines are not aligned semantically between panes
- **Example**: Line 8 on left shows `const data = parseInput()` while line 8 on right shows `}`
- **Impact**: Users must mentally map corresponding changes
- **Fix**: Implement line-pairing algorithm or show unified diff markers

#### ~~Medium: Ambiguous Pane Labels~~ âœ… FIXED
**Heuristic**: #1 Visibility of System Status
- **Issue**: Both tabs showed similar names (`test_review.ts` vs `HEAD:test_review.ts`)
- **Fix**: OLD pane now labeled `[OLD â—€] filename` with arrow indicator

#### Medium: No Help in Split View
**Heuristic**: #10 Help and Documentation
- **Issue**: Help keybindings visible in review buffer disappear in split view
- **Impact**: Users don't know available actions in split view mode
- **Fix**: Add floating help or status bar hints

#### Low: Byte-Based vs Line-Based Sync
**Heuristic**: #4 Consistency and Standards
- **Issue**: Scroll sync uses `top_byte` offset, not line numbers
- **Impact**: Files with different line lengths may scroll at different rates
- **Recommendation**: Consider line-based synchronization for semantic alignment

### What Works Well

| Aspect | Assessment |
|--------|------------|
| Vertical split layout | Good use of screen real estate |
| Synchronized scrolling | Works for basic navigation |
| Color-coded diff lines | Clear visual distinction (when colors render) |
| 0.5 ratio split | Equal space for comparison |

### Recommended Fixes (Priority Order)

1. ~~**Enforce read-only on OLD pane**~~ âœ… DONE - Added `editing_disabled: true`
2. **Swap pane order to OLD|NEW** - Requires split API enhancement (left-side split)
3. ~~**Add clear pane labels**~~ âœ… DONE - `[OLD â—€]` prefix on old file tab
4. **Implement line alignment** - Significant effort, high value

---

## Known Issues / TODO

### High Priority
1. **Arrow key navigation only**: `j`/`k` don't work in review-mode (use arrow keys)
2. **No prompt display**: Original request from agent not shown
3. **No summary header**: No at-a-glance change statistics
4. **Side-by-side pane order reversed**: NEW|OLD instead of OLD|NEW (API limitation, mitigated with labels)

### Medium Priority
5. **No safety warnings**: Secrets, deletions not highlighted
6. **No persistence**: Comments lost on editor restart
7. **No edit/delete comments**: Can only add, not modify
8. **No line alignment in split view**: Lines don't correspond semantically
9. **No help in split view**: Keybindings not visible in side-by-side mode

### Low Priority
10. **No confidence indicators**: All changes look equally confident
11. **No semantic grouping**: Changes shown by file, not by logical function
12. **No LSP integration**: Can't show impact analysis

---

## Development History

- **2025-12-22**: Initial Review Diff implementation
- **2025-12-28**: Added review comments with file line numbers
- **2025-12-28**: Fixed inline comment rendering for paired diffs
- **2025-12-28**: Added help header with keybindings
- **2025-12-28**: Export includes line-specific comment info
- **2025-12-28**: UX evaluation of side-by-side view (NN/g heuristics)
- **2025-12-29**: Fixed read-only enforcement on OLD pane (`editing_disabled: true`)
- **2025-12-29**: Added clear `[OLD â—€]` label to distinguish reference version
